# SPARC Implementation Plan: iOS/iPadOS Companion App for Airmail2Hookmark

> Generated by claude-flow hive-mind with specialized agents:
> - iOS-System-Architect
> - iOS-Platform-Researcher
> - Swift-Implementation-Specialist
> - Requirements-Analyst

---

## S - Specification

### Functional Requirements

1. **URL Scheme Handling**
   - Register as a handler for the `airmail:` URL scheme on iOS/iPadOS
   - Accept URLs in the format: `airmail://message?mail={email}&messageid={id}`
   - Transform and redirect to either `hook://email/{id}` or `message://%3C{id}%3E`

2. **Settings Interface**
   - SwiftUI-based settings screen with scheme selection (Hookmark vs Apple Mail)
   - Persist user preference using UserDefaults (can share via App Groups if needed)
   - No "Launch at Login" feature (not applicable on iOS)

3. **Redirection Behavior**
   - When opened via URL, transform the URL and open the target app
   - Display error alerts for malformed URLs
   - Minimize time spent in app (redirect quickly)

4. **Universal Support**
   - Support iPhone (iOS 15+)
   - Support iPad (iPadOS 15+)
   - Adaptive layouts for all screen sizes

### Technical Requirements

| Requirement | macOS App | iOS App (Proposed) |
|-------------|-----------|-------------------|
| Minimum OS | macOS 13 | iOS 15 / iPadOS 15 |
| Swift Version | 5.9+ | 5.9+ |
| UI Framework | AppKit + SwiftUI | SwiftUI (native) |
| URL Opening | `NSWorkspace.shared.open()` | `UIApplication.shared.open()` |
| Preferences | UserDefaults | UserDefaults |
| App Type | Menu bar agent (LSUIElement) | Standard app (minimal UI) |
| URL Registration | Info.plist CFBundleURLTypes | Info.plist CFBundleURLTypes |

### Platform Constraints and Differences

1. **iOS URL Scheme Handling Semantics**
   - On iOS, when your app handles a URL, iOS launches your app in the foreground
   - There is no way to handle a URL "silently" in the background like macOS
   - After opening a URL via `UIApplication.shared.open()`, the user stays in the target app
   - The calling app (that clicked the airmail: link) is in the background

2. **No Background Processing**
   - iOS does not allow apps to run invisibly like macOS menu bar agents
   - The app will briefly appear when handling a URL, then open the target URL

3. **No Launch at Login**
   - iOS does not have a "launch at login" concept
   - The LoginItemManager service is macOS-only and will not be shared

4. **Hookmark Availability**
   - Hookmark has an iOS app, but verify that `hook://` scheme works on iOS
   - Apple Mail `message://` scheme works on iOS for opening specific emails

---

## P - Pseudocode

### App Lifecycle Flow for URL Handling

```
App Launch Flow:
1. App initializes with SwiftUI @main
2. Check if launched via URL or normal launch

URL Handling Flow:
1. iOS delivers URL via onOpenURL or scene delegate
2. Extract URL from the event
3. Call URLTransformer.transform(airmailURL:scheme:)
4. If success:
   a. Call UIApplication.shared.open(transformedURL)
   b. App remains in background after URL opens
5. If failure:
   a. Show error alert to user
   b. User must dismiss and manually navigate

Normal Launch Flow:
1. App shows Settings screen directly
2. User can configure preferred URI scheme
3. No other actions needed - app just waits for URL events
```

### Settings View Logic (SwiftUI)

```swift
struct SettingsView: View {
    @AppStorage("selectedURIScheme") var selectedScheme: String = "hook"

    var body: some View {
        NavigationStack {
            Form {
                Section("Output URL Scheme") {
                    Picker("Scheme", selection: $selectedScheme) {
                        Text("Hookmark (hook://email/...)").tag("hook")
                        Text("Apple Mail (message://...)").tag("message")
                    }
                    .pickerStyle(.inline)
                    .labelsHidden()
                }

                Section("About") {
                    Text("Airmail2Hookmark")
                    Text("Redirects Airmail URLs to your preferred email client")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            .navigationTitle("Settings")
        }
    }
}
```

### URL Transformation (Reusable from macOS)

The existing `URLTransformer.swift` and `PreferencesManager.swift` can be reused directly with minimal modifications:

```swift
// URLTransformer.transform(airmailURL:scheme:) -> Result<URL, URLTransformError>
//   - Parse incoming airmail URL
//   - Extract messageid parameter
//   - Construct hook:// or message:// URL
//   - Return result

// PreferencesManager.shared.selectedScheme -> URIScheme
//   - Read/write to UserDefaults
//   - Default to .hookmark
```

---

## A - Architecture

### Recommended Project Structure

```
Airmail2Hook/
├── Package.swift                    # SPM package (if using SPM)
├── Airmail2Hookmark/                # Existing macOS app
│   └── Sources/
│       ├── App/
│       ├── Services/
│       ├── UI/
│       └── Resources/
├── Airmail2HookmarkiOS/             # NEW: iOS app target
│   └── Sources/
│       ├── App/
│       │   └── Airmail2HookmarkiOSApp.swift
│       ├── Views/
│       │   ├── SettingsView.swift
│       │   └── AboutView.swift
│       └── Resources/
│           ├── Info.plist
│           └── Assets.xcassets
├── Shared/                          # NEW: Shared code between macOS & iOS
│   ├── URLTransformer.swift         # Moved from macOS
│   ├── URIScheme.swift              # Extracted from PreferencesManager
│   └── PreferencesManager.swift     # Shared (remove LoginItemManager dependency)
└── Tests/
    └── URLTransformerTests.swift    # Shared tests
```

### File Responsibilities

| File | Purpose |
|------|---------|
| `Airmail2HookmarkiOSApp.swift` | SwiftUI @main entry point, URL handling |
| `SettingsView.swift` | SwiftUI form for scheme selection |
| `AboutView.swift` | App info display |
| `Info.plist` | iOS-specific config, URL scheme registration |
| `Shared/URLTransformer.swift` | URL transformation logic (unchanged) |
| `Shared/URIScheme.swift` | Enum for hook/message schemes |
| `Shared/PreferencesManager.swift` | UserDefaults wrapper (simplified) |

### SwiftUI View Hierarchy

```
Airmail2HookmarkiOSApp (@main)
└── ContentView (wrapper that handles routing)
    ├── SettingsView (main interface)
    │   ├── Section: Output URL Scheme
    │   │   └── Picker (Hookmark / Apple Mail)
    │   └── Section: About
    │       └── AboutView
    └── ErrorAlertModifier (for URL transform errors)
```

### Data Flow Diagram

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  External App   │     │   iOS System     │     │  Airmail2Hook   │
│  (Notes, etc.)  │     │                  │     │   iOS App       │
└────────┬────────┘     └────────┬─────────┘     └────────┬────────┘
         │                       │                        │
         │ User taps             │                        │
         │ airmail:// link       │                        │
         │──────────────────────>│                        │
         │                       │                        │
         │                       │ Launches app with URL  │
         │                       │───────────────────────>│
         │                       │                        │
         │                       │                        │ Transform URL
         │                       │                        │ using URLTransformer
         │                       │                        │
         │                       │ UIApplication.open()   │
         │                       │<───────────────────────│
         │                       │                        │
         │                       │ Opens target app       │
         │                       │ (Hookmark/Mail)        │
         │                       │                        │
         │                       ▼                        │
                          ┌──────────────────┐
                          │  Target App      │
                          │  (Hookmark/Mail) │
                          └──────────────────┘
```

### Shared Code Strategy

**Option A: Xcode Project with Multiple Targets (Recommended)**
- Single Xcode project
- macOS target, iOS target
- Shared framework target or shared source files
- Easiest for development

**Option B: Swift Package Manager Modularization**
- Create `Airmail2HookmarkCore` package with shared code
- Both apps depend on this package
- Better for larger projects, more setup overhead

**Recommendation**: Start with Option A (multiple targets, shared source files) for simplicity. The shared code is minimal (2-3 files).

---

## R - Refinement

### iOS Limitations on URL Scheme Handling

1. **No Silent Handling**: Unlike macOS where the app can remain invisible, iOS will briefly show the app when handling a URL. This is unavoidable.

2. **No Automatic Return**: After `UIApplication.shared.open()`, the user remains in the opened app (Hookmark or Mail). They cannot automatically return to the app that originally contained the link.

3. **URL Scheme Conflicts**: If the real Airmail app is installed on the same device, iOS may prompt the user to choose which app handles the URL, or give priority to the original Airmail app. This is a significant consideration.

4. **No Background URL Handling**: There is no equivalent to macOS's ability to handle URLs without activating.

### Mitigation for Airmail Conflict

If the user has both Airmail and Airmail2Hookmark iOS installed:
- iOS typically gives priority to the app that "owns" the scheme
- The user may need to uninstall Airmail for Airmail2Hookmark to work
- Document this limitation clearly

### Edge Cases

| Edge Case | Handling Strategy |
|-----------|-------------------|
| Missing `messageid` parameter | Show alert with error message |
| Empty `messageid` value | Show alert with error message |
| Invalid URL scheme (not airmail:) | Should not occur (iOS won't route to us) |
| Target app not installed | iOS shows "Cannot open URL" alert automatically |
| User cancels URL open | N/A - UIApplication.open() doesn't have cancel |
| Very long message IDs | Pass through (URL class handles) |
| URL-encoded characters | Preserve encoding (existing behavior) |

### Error Handling Strategy

```swift
// In the SwiftUI App
@main
struct Airmail2HookmarkiOSApp: App {
    @State private var errorMessage: String?
    @State private var showError = false

    var body: some Scene {
        WindowGroup {
            SettingsView()
                .onOpenURL { url in
                    handleIncomingURL(url)
                }
                .alert("Unable to Transform URL", isPresented: $showError) {
                    Button("OK") { }
                } message: {
                    Text(errorMessage ?? "Unknown error")
                }
        }
    }

    private func handleIncomingURL(_ url: URL) {
        let result = URLTransformer.transform(
            airmailURL: url,
            scheme: PreferencesManager.shared.selectedScheme
        )

        switch result {
        case .success(let outputURL):
            UIApplication.shared.open(outputURL) { success in
                if !success {
                    errorMessage = "Could not open \(outputURL.scheme ?? "URL"). Is the target app installed?"
                    showError = true
                }
            }
        case .failure(let error):
            errorMessage = errorDescription(for: error, originalURL: url)
            showError = true
        }
    }
}
```

### User Feedback Mechanisms

1. **Success Case**: No explicit feedback needed - the target app opens immediately
2. **Error Case**: SwiftUI alert with descriptive message
3. **Target App Missing**: iOS system alert (automatic)
4. **Settings Confirmation**: Use `@AppStorage` for instant persistence, no save button needed

---

## C - Completion

### Testing Strategy

#### Unit Tests (Shared)

The existing `URLTransformerTests.swift` can be reused completely. It tests:
- Valid URL transformations (Hookmark and Apple Mail schemes)
- Error cases (missing/empty messageid, invalid scheme)
- Edge cases (encoded characters, long IDs, multiple parameters)

```swift
// All 30+ existing tests apply to iOS with no changes
// Tests are platform-agnostic
```

#### UI Tests (iOS-specific)

```swift
final class Airmail2HookmarkiOSUITests: XCTestCase {

    func testSettingsViewDisplaysSchemeSelector() {
        let app = XCUIApplication()
        app.launch()

        // Verify scheme picker exists
        XCTAssertTrue(app.pickers["Output URL Scheme"].exists)
    }

    func testSchemeSelectionPersists() {
        let app = XCUIApplication()
        app.launch()

        // Select Apple Mail
        app.buttons["Apple Mail (message://...)"].tap()

        // Restart app
        app.terminate()
        app.launch()

        // Verify selection persisted
        // (Check picker value)
    }

    func testURLHandlingWithValidURL() {
        // Use XCTest's URL handling to open app with test URL
        // Verify app transforms and attempts to open target URL
        // Note: Cannot fully test cross-app opening in UI tests
    }
}
```

#### Manual Testing Checklist

- [ ] Install app on iPhone, open `airmail://` link from Notes
- [ ] Verify Hookmark opens with correct message ID
- [ ] Change setting to Apple Mail, test again
- [ ] Verify Mail opens with correct message ID
- [ ] Test on iPad with same scenarios
- [ ] Test with malformed URL, verify error alert
- [ ] Test when Hookmark is not installed
- [ ] Test when competing with real Airmail app (if applicable)

### TestFlight Distribution Plan

1. **Internal Testing Phase**
   - Add team members to TestFlight internal testing
   - Test on variety of devices (iPhone SE, iPhone Pro, iPad)
   - Verify URL handling works as expected
   - Duration: 1-2 weeks

2. **External Testing Phase** (Optional)
   - Invite external beta testers if desired
   - Collect feedback on usability
   - Duration: 2-4 weeks

3. **App Store Connect Setup**
   - App name: "Airmail2Hookmark" or "Airmail URL Redirector"
   - Category: Utilities
   - Privacy policy URL (required)
   - App description focusing on use case

### App Store Considerations

1. **App Review Guidelines**
   - The app serves a legitimate utility purpose
   - URL scheme handling is allowed
   - Must not impersonate Airmail (use distinct branding)

2. **Metadata Requirements**
   - Screenshots: Settings screen on iPhone and iPad
   - Description: Explain use case (migrating from Airmail, preserving links)
   - Keywords: airmail, hookmark, email, links, redirect

3. **Privacy**
   - App collects no user data
   - No analytics
   - No network requests
   - Privacy policy can be simple (no data collection)

4. **Potential Rejection Risks**
   - If Apple considers the app too narrow in functionality
   - Mitigation: Emphasize utility value for users migrating email clients

### Integration with macOS App (Shared Codebase)

**Recommended Xcode Project Structure:**

```
Airmail2Hookmark.xcodeproj/
├── Targets:
│   ├── Airmail2Hookmark (macOS)
│   ├── Airmail2HookmarkiOS (iOS)
│   └── Airmail2HookmarkTests (shared tests)
├── Shared Sources:
│   ├── URLTransformer.swift       [macOS, iOS, Tests]
│   ├── URIScheme.swift            [macOS, iOS, Tests]
│   └── PreferencesManager.swift   [macOS, iOS] (platform-specific tweaks)
├── macOS-only Sources:
│   ├── AppDelegate.swift
│   ├── StatusBarController.swift
│   ├── LoginItemManager.swift
│   └── Settings/AboutWindowController.swift
├── iOS-only Sources:
│   ├── Airmail2HookmarkiOSApp.swift
│   ├── SettingsView.swift
│   └── AboutView.swift
```

**Migration Steps:**

1. Convert from SPM-only to Xcode project (or add Xcode project alongside Package.swift)
2. Create iOS target in Xcode
3. Move `URLTransformer.swift` and `URIScheme.swift` to shared folder
4. Create iOS-specific `PreferencesManager.swift` variant (without LoginItemManager)
5. Add shared files to both targets
6. Create iOS-specific UI files
7. Configure iOS Info.plist with URL scheme

---

## Implementation Phases

### Phase 1: Project Setup
- Create Xcode project with dual targets
- Configure shared source files
- Set up iOS Info.plist with URL scheme registration

### Phase 2: Core Functionality
- Implement `Airmail2HookmarkiOSApp.swift` with URL handling
- Verify URLTransformer works on iOS
- Test URL transformation flow

### Phase 3: Settings UI
- Build `SettingsView.swift` in SwiftUI
- Implement `AboutView.swift`
- Connect to PreferencesManager

### Phase 4: Testing
- Run existing unit tests against iOS target
- Create UI tests
- Manual testing on devices

### Phase 5: Distribution
- Set up App Store Connect
- Configure TestFlight
- Submit for review

---

## iOS Info.plist Template

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleName</key>
    <string>Airmail2Hookmark</string>
    <key>CFBundleDisplayName</key>
    <string>Airmail2Hookmark</string>
    <key>CFBundleIdentifier</key>
    <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
    <key>CFBundleVersion</key>
    <string>1</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0.0</string>

    <!-- URL Scheme Handler -->
    <key>CFBundleURLTypes</key>
    <array>
        <dict>
            <key>CFBundleURLName</key>
            <string>com.airmail2hookmark.airmail-scheme</string>
            <key>CFBundleURLSchemes</key>
            <array>
                <string>airmail</string>
            </array>
            <key>CFBundleTypeRole</key>
            <string>Viewer</string>
        </dict>
    </array>

    <!-- Minimum iOS Version -->
    <key>MinimumOSVersion</key>
    <string>15.0</string>

    <!-- Device Families: 1=iPhone, 2=iPad -->
    <key>UIDeviceFamily</key>
    <array>
        <integer>1</integer>
        <integer>2</integer>
    </array>

    <key>UILaunchScreen</key>
    <dict/>

    <key>UISupportedInterfaceOrientations</key>
    <array>
        <string>UIInterfaceOrientationPortrait</string>
        <string>UIInterfaceOrientationLandscapeLeft</string>
        <string>UIInterfaceOrientationLandscapeRight</string>
    </array>

    <key>UISupportedInterfaceOrientations~ipad</key>
    <array>
        <string>UIInterfaceOrientationPortrait</string>
        <string>UIInterfaceOrientationPortraitUpsideDown</string>
        <string>UIInterfaceOrientationLandscapeLeft</string>
        <string>UIInterfaceOrientationLandscapeRight</string>
    </array>
</dict>
</plist>
```

---

## Key Implementation Files

### Airmail2HookmarkiOSApp.swift (Complete Implementation)

```swift
import SwiftUI

@main
struct Airmail2HookmarkiOSApp: App {
    @State private var errorMessage: String?
    @State private var showError = false

    var body: some Scene {
        WindowGroup {
            SettingsView()
                .onOpenURL { url in
                    handleIncomingURL(url)
                }
                .alert("Unable to Transform URL", isPresented: $showError) {
                    Button("OK") { }
                } message: {
                    Text(errorMessage ?? "Unknown error")
                }
        }
    }

    private func handleIncomingURL(_ url: URL) {
        let selectedScheme = PreferencesManager.shared.selectedScheme
        let result = URLTransformer.transform(airmailURL: url, scheme: selectedScheme)

        switch result {
        case .success(let outputURL):
            UIApplication.shared.open(outputURL) { success in
                if !success {
                    DispatchQueue.main.async {
                        errorMessage = "Could not open the URL. Is \(selectedScheme == .hookmark ? "Hookmark" : "Mail") installed?"
                        showError = true
                    }
                }
            }

        case .failure(let error):
            errorMessage = errorDescription(for: error, originalURL: url)
            showError = true
        }
    }

    private func errorDescription(for error: URLTransformError, originalURL: URL) -> String {
        switch error {
        case .invalidScheme:
            return "The URL does not use the airmail: scheme.\n\nReceived: \(originalURL.absoluteString)"
        case .missingMessageId:
            return "The airmail URL is missing the required 'messageid' parameter.\n\nReceived: \(originalURL.absoluteString)"
        case .emptyMessageId:
            return "The airmail URL has an empty 'messageid' parameter.\n\nReceived: \(originalURL.absoluteString)"
        case .invalidURLConstruction:
            return "Failed to construct the output URL.\n\nOriginal: \(originalURL.absoluteString)"
        }
    }
}
```

### SettingsView.swift (Complete Implementation)

```swift
import SwiftUI

struct SettingsView: View {
    @State private var selectedScheme: URIScheme = PreferencesManager.shared.selectedScheme

    var body: some View {
        NavigationStack {
            Form {
                Section {
                    Picker("Output URL Scheme", selection: $selectedScheme) {
                        ForEach(URIScheme.allCases, id: \.self) { scheme in
                            Text(scheme.displayName).tag(scheme)
                        }
                    }
                    .pickerStyle(.inline)
                    .labelsHidden()
                    .onChange(of: selectedScheme) { newValue in
                        PreferencesManager.shared.selectedScheme = newValue
                    }
                } header: {
                    Text("Output URL Scheme")
                } footer: {
                    Text("Choose which app should open when you tap an Airmail link.")
                }

                Section("About") {
                    HStack {
                        Text("Version")
                        Spacer()
                        Text(Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "1.0")
                            .foregroundColor(.secondary)
                    }

                    Text("Airmail2Hookmark redirects airmail:// URLs to your preferred email linking app, preserving your existing deep links after migrating away from Airmail.")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            .navigationTitle("Airmail2Hookmark")
        }
    }
}

#Preview {
    SettingsView()
}
```

---

## Summary

This iOS companion app is a straightforward port of the macOS functionality with platform-appropriate adaptations:

- **Shared code**: URLTransformer and URIScheme (100% reusable)
- **New iOS code**: ~150 lines (App + SettingsView)
- **Key difference**: SwiftUI-native UI instead of AppKit
- **Key limitation**: Cannot handle URLs silently like macOS

The implementation is low-risk with high code reuse from the existing macOS app.
